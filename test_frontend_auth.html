<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frontend Auth Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .result { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border-radius: 3px; }
        .step { margin: 10px 0; padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <h1>üç™ Frontend Authentication Test</h1>
    
    <div class="test info">
        <h3>Test Status</h3>
        <div id="status">Ready to test</div>
    </div>

    <div class="step">
        <h3>üîß Instructions</h3>
        <p>1. Start your Docker containers: <code>docker-compose up -d</code></p>
        <p>2. Run the tests below</p>
        <p>3. After login, refresh the page to test session persistence</p>
        <p>4. Check browser console for authentication logs</p>
    </div>

    <div class="test">
        <h3>1. Register User</h3>
        <input type="email" id="email" placeholder="Email" value="test@example.com">
        <input type="password" id="password" placeholder="Password" value="password123">
        <input type="text" id="firstName" placeholder="First Name" value="Test">
        <input type="text" id="lastName" placeholder="Last Name" value="User">
        <br>
        <button onclick="register()">Register</button>
        <div id="registerResult" class="result"></div>
    </div>

    <div class="test">
        <h3>2. Login</h3>
        <input type="email" id="loginEmail" placeholder="Email" value="test@example.com">
        <input type="password" id="loginPassword" placeholder="Password" value="password123">
        <br>
        <button onclick="login()">Login</button>
        <div id="loginResult" class="result"></div>
    </div>

    <div class="test">
        <h3>3. Test Protected Endpoint</h3>
        <button onclick="testProtected()">Test /auth/me</button>
        <div id="protectedResult" class="result"></div>
    </div>

    <div class="test">
        <h3>4. Test Token Refresh</h3>
        <button onclick="testRefresh()">Test Refresh</button>
        <div id="refreshResult" class="result"></div>
    </div>

    <div class="test">
        <h3>5. Test Session Persistence</h3>
        <p>After logging in, try refreshing this page and clicking "Test Protected Endpoint" again.</p>
        <button onclick="testSessionPersistence()">Test Session Persistence</button>
        <div id="sessionResult" class="result"></div>
    </div>

    <div class="test">
        <h3>6. Check Cookies</h3>
        <button onclick="checkCookies()">Check Cookies</button>
        <div id="cookiesResult" class="result"></div>
    </div>

    <div class="test">
        <h3>7. Test Logout</h3>
        <button onclick="logout()">Logout</button>
        <div id="logoutResult" class="result"></div>
    </div>

    <div class="test">
        <h3>8. Test After Logout</h3>
        <button onclick="testAfterLogout()">Test Protected Endpoint After Logout</button>
        <div id="afterLogoutResult" class="result"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = type;
        }

        function showResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = 'result ' + (isError ? 'error' : 'success');
        }

        async function register() {
            updateStatus('Registering...');
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: document.getElementById('email').value,
                        password: document.getElementById('password').value,
                        first_name: document.getElementById('firstName').value,
                        last_name: document.getElementById('lastName').value
                    })
                });
                
                const data = await response.json();
                showResult('registerResult', { status: response.status, data });
                updateStatus('Registration completed');
            } catch (error) {
                showResult('registerResult', { error: error.message }, true);
                updateStatus('Registration failed', 'error');
            }
        }

        async function login() {
            updateStatus('Logging in...');
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: document.getElementById('loginEmail').value,
                        password: document.getElementById('loginPassword').value
                    })
                });
                
                const data = await response.json();
                showResult('loginResult', { status: response.status, data });
                updateStatus('Login completed - try refreshing the page now!');
            } catch (error) {
                showResult('loginResult', { error: error.message }, true);
                updateStatus('Login failed', 'error');
            }
        }

        async function testProtected() {
            updateStatus('Testing protected endpoint...');
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                showResult('protectedResult', { status: response.status, data });
                updateStatus('Protected endpoint test completed');
            } catch (error) {
                showResult('protectedResult', { error: error.message }, true);
                updateStatus('Protected endpoint test failed', 'error');
            }
        }

        async function testRefresh() {
            updateStatus('Testing token refresh...');
            try {
                const response = await fetch(`${API_BASE}/auth/refresh`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                showResult('refreshResult', { status: response.status, data });
                updateStatus('Token refresh completed');
            } catch (error) {
                showResult('refreshResult', { error: error.message }, true);
                updateStatus('Token refresh failed', 'error');
            }
        }

        async function testSessionPersistence() {
            updateStatus('Testing session persistence...');
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                showResult('sessionResult', { 
                    status: response.status, 
                    data,
                    message: 'If this works, your session is persistent!'
                });
                updateStatus('Session persistence test completed');
            } catch (error) {
                showResult('sessionResult', { error: error.message }, true);
                updateStatus('Session persistence test failed', 'error');
            }
        }

        async function logout() {
            updateStatus('Logging out...');
            try {
                const response = await fetch(`${API_BASE}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                showResult('logoutResult', { status: response.status, data });
                updateStatus('Logout completed');
            } catch (error) {
                showResult('logoutResult', { error: error.message }, true);
                updateStatus('Logout failed', 'error');
            }
        }

        async function testAfterLogout() {
            updateStatus('Testing after logout...');
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    method: 'GET',
                    credentials: 'include'
                });
                
                const data = await response.json();
                showResult('afterLogoutResult', { status: response.status, data });
                updateStatus('After logout test completed');
            } catch (error) {
                showResult('afterLogoutResult', { error: error.message }, true);
                updateStatus('After logout test failed', 'error');
            }
        }

        function checkCookies() {
            updateStatus('Checking cookies...');
            try {
                const cookies = document.cookie;
                const cookieList = cookies ? cookies.split(';').map(c => c.trim()) : [];
                showResult('cookiesResult', { 
                    totalCookies: cookieList.length,
                    cookies: cookieList,
                    cookieString: cookies,
                    message: 'Look for session_token and refresh_token cookies'
                });
                updateStatus('Cookie check completed');
            } catch (error) {
                showResult('cookiesResult', { error: error.message }, true);
                updateStatus('Cookie check failed', 'error');
            }
        }

        // Check if backend is accessible
        async function checkBackend() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    updateStatus('Backend is accessible', 'success');
                } else {
                    updateStatus('Backend health check failed', 'error');
                }
            } catch (error) {
                updateStatus('Backend not accessible: ' + error.message, 'error');
            }
        }

        // Check backend on page load
        checkBackend();
    </script>
</body>
</html>
